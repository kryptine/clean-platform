test-nightly:
  before_script:
    - install_clean.sh bundle-complete
    - apt-get update -qq
    - apt-get install -y -qq build-essential git coreutils libsnappy-dev

    - make -C src/cdeps install

    - git clone https://gitlab.science.ru.nl/clean-compiler-and-rts/compiler tests/linux64/compiler
    - make -j -C tests/linux64/compiler/main/Unix
    - make -j -C tests/linux64/compiler/backendC/CleanCompilerSources -f Makefile.linux64
    - mkdir -p tests/linux64/compiler/backend/Clean\ System\ Files
    - ln -fs ../../backendC/CleanCompilerSources/backend.a tests/linux64/compiler/backend/Clean\ System\ Files/backend_library
  image: "camilstaps/clean:nightly"
  script:
    - COCLPATH=./compiler make -C tests/linux64 run
    - stdbuf -o0 -e0 testproperties -IL Dynamics -d src/libraries/OS-Independent -P Quiet -r -T 'Tests 100000' -C -h -C 100m

test-stable:
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq patch build-essential coreutils libsnappy-dev
    - make -C src/cdeps install
    - install_clean.sh "stable lib-dynamics lib-tcpip lib-graphcopy lib-graphcopy test"
  image: "camilstaps/clean:nightly"
  script:
    - make -C tests/linux64 run
  allow_failure: true
